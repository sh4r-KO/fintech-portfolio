<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backtrader — Run & Plot</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header class="container header">
    <a href="/" class="logo">Home</a>
    <nav>
      <a href="/#projects">Projects</a>
      <a href="/#about">About</a>
      <a href="/#contact">Contact</a>
    </nav>
  </header>

  <main class="container">
    <section class="about">
      <h2>Backtrader — Strategy Runner</h2>
      <form id="btForm">
        <div class="row two-col">
          <label>Symbol
            <input name="symbol" id="btSymbol" placeholder="AAPL" required value="AAPL" />
          </label>
          <label>Strategy
            <select name="strategy" id="btStrategy" required></select>
          </label>
        </div>

        <div class="row two-col">
          <label>Start date
            <input name="start_period" id="btStart" type="date" value="2005-01-01" />
          </label>
          <label>End date
            <input name="end_period" id="btEnd" type="date" value="2020-01-01" />
          </label>
        </div>

        <div class="row three-col">
          <label>Starting capital
            <input name="starting_capital" id="btCash" type="number" step="any" value="10000" />
          </label>
          <label>Commission (fraction)
            <input name="commission" id="btComm" type="number" step="any" value="0.001" />
          </label>


          <div class="row">
            <label>Slippage (fraction)
              <input name="slippage" id="btSlip" type="number" step="any" value="0.01" />
            </label>
          </div>
        </div>

        <button type="submit">Run Backtest</button>
        <small id="btStatus" class="muted"></small>
      </form>

      <div id="btResults" class="article" style="display:none">
        <h3>KPIs</h3>
        <ul class="metrics" id="btMetrics"></ul>

        <div id="btPlotWrap" style="margin-top:10px; display:none">
          <h3>Plot(s)</h3>
          <div id="btPlots" class="grid" style="gap:12px"></div>
        </div>

        <div id="btKpiPngWrap" style="margin-top:10px; display:none">
          <h3>KPI Images</h3>
          <div id="btKpiPngs" class="grid" style="gap:12px"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="container footer"><small>© <span id="y"></span> [Aguirre Cabrol]</small></footer>

  <script>
    window.API_BASE = "https://fintech-portfolio-546985714630.europe-west1.run.app";
    document.getElementById('y').textContent = new Date().getFullYear();

    const sel = document.getElementById('btStrategy');
    const statusEl = document.getElementById('btStatus');
    const resultsWrap = document.getElementById('btResults');
    const metricsEl = document.getElementById('btMetrics');
    const plotWrap = document.getElementById('btPlotWrap');
    const plotsEl = document.getElementById('btPlots');
    const kpiWrap = document.getElementById('btKpiPngWrap');
    const kpiEl = document.getElementById('btKpiPngs');

    // Populate strategies from backend
    (async () => {
      try {
        const res = await fetch(`${window.API_BASE}/api/strategies`);
        const data = res.ok ? await res.json() : { items: ["SmaCross", "Rsi2", "EmaCross"] };
        const items = data.items || data;
        sel.innerHTML = items.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch {
        sel.innerHTML = `<option value="SmaCross">SmaCross</option>`;
      }
    })();

    // Form submit → run backtest
    document.getElementById('btForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Running…';
      resultsWrap.style.display = 'none';
      plotWrap.style.display = 'none';
      kpiWrap.style.display = 'none';
      plotsEl.innerHTML = '';
      kpiEl.innerHTML = '';

      const fd = new FormData(e.currentTarget);
      const payload = {
        symbol: fd.get('symbol')?.trim() || undefined,
        // name must match the backend: "strategy" (or "strat")
        strategy: fd.get('strategy') || fd.get('strat') || undefined,
        start_period: fd.get('start_period') || undefined,
        end_period: fd.get('end_period') || undefined,
        starting_capital: fd.get('starting_capital') ? Number(fd.get('starting_capital')) : undefined,
        commission: fd.get('commission') ? Number(fd.get('commission')) : undefined,
        slippage: fd.get('slippage') ? Number(fd.get('slippage')) : undefined,
      };
      // strip undefineds
      Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);


      try {
        console.log('payload', payload)
        const res = await fetch(`${window.API_BASE}/api/backtest`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('backtest failed');
        const out = await res.json();
        renderResults(out);

        // ------- Results renderer (clean) -------
        const ABS = (u) => /^https?:\/\//i.test(u) ? u : (window.API_BASE.replace(/\/$/, '') + u);

        function formatValue(key, val) {
          if (typeof val === 'string') return val || '—';
          if (val === null || val === undefined || !isFinite(Number(val))) return '—';

          // pourcentages
          const pctKeys = ['TotalReturn_%', 'rnorm100_%', 'MaxDrawdown_%', 'WinRate_%'];
          if (pctKeys.includes(key)) {
            return (Number(val) * 100).toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' %';
          }
          // nombres "normaux"
          const digits = Math.abs(Number(val)) >= 100 ? 2 : 4;
          return Number(val).toLocaleString(undefined, { maximumFractionDigits: digits });
        }

        function renderResults(out) {
          // reset
          resultsWrap.style.display = 'none';
          plotWrap.style.display = 'none';
          metricsEl.innerHTML = '';
          plotsEl.innerHTML = '';

          // ----- KPIs -----
          const m = out?.metrics || {};
          const order = [
            'Symbol', 'Strategy', 'TotalReturn_%', 'rnorm100_%', 'SharpeDaily', 'SharpeAnnual',
            'Calmar', 'MaxDrawdown_%', 'TimeDD_bars', 'VWR', 'SQN', 'WinRate_%',
            'ProfitFactor', 'AvgTradePL', 'trades_total', 'Sortino'
          ];

          const rows = [];
          order.forEach(k => (k in m) && rows.push([k, m[k]]));
          // ajoute tout le reste (si présent)
          Object.keys(m).forEach(k => { if (!order.includes(k)) rows.push([k, m[k]]); });

          metricsEl.innerHTML = rows.map(([k, v]) => {
            const label = k.replaceAll('_', ' ');
            return `<li><strong>${label}:</strong> ${formatValue(k, v)}</li>`;
          }).join('');

          // ----- Plot -----
          if (out?.plot) {
            const src = ABS(out.plot);                   // gros "pretty" plot
            plotsEl.innerHTML = `
      <img id="btPretty" src="${src}" alt="backtest plot"
           style="width:100%;max-width:1200px;border:1px solid #e5e7eb;border-radius:12px"
           onload="this.scrollIntoView({behavior:'smooth'})"
           onerror="this.closest('#btPlotWrap').style.display='none';">
    `;
            plotWrap.style.display = '';
          } else if (Array.isArray(out?.charts) && out.charts.length) {
            // fallback: petites images KPI
            plotsEl.innerHTML = out.charts.map(u => `
      <img src="${ABS(u)}" alt="backtest plot"
           style="max-width:100%;border:1px solid #e5e7eb;border-radius:12px" />
    `).join('');
            plotWrap.style.display = '';
          }

          resultsWrap.style.display = '';
          statusEl.textContent = '';
        }



      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error running backtest. Please check inputs and try again.';
      }
    });
  </script>
</body>

</html>