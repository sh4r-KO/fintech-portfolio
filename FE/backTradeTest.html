<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backtrader — Run & Plot</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header class="container header">
    <a href="/" class="logo">Home</a>
    <nav>
      <a href="/#projects">Projects</a>
      <a href="/#about">About</a>
      <a href="/#contact">Contact</a>
    </nav>
  </header>

  <main class="container">
    <section class="about">
      <h2>Backtrader — Strategy Runner</h2>

      <!-- FORM -->
      <form id="btForm">
        <div class="row two-col">
          <label>Symbol
            <input name="symbol" id="btSymbol" placeholder="AAPL" required value="AAPL" />
          </label>
          <label>Strategy
            <select name="strategy" id="btStrategy" required></select>
          </label>
        </div>

        <div class="row two-col">
          <label>Start date
            <input name="start_period" id="btStart" type="date" value="2005-01-01" />
          </label>
          <label>End date
            <input name="end_period" id="btEnd" type="date" value="2020-01-01" />
          </label>
        </div>

        <div class="row two-col">
          <label>Starting capital ($)
            <input name="starting_capital" id="btCash" type="number" step="any" value="10000" />
          </label>
          <label>Commission (%)
            <input name="commission" id="btComm" type="text" value="0.001" />
          </label>
        </div>

        <div class="row">
          <label>Slippage (%)
            <input name="slippage" id="btSlip" type="text" value="0.01" />
          </label>
        </div>

        <button type="submit">Run Backtest</button>
        <small id="btStatus" class="muted"></small>
      </form>

      <!-- RESULTS -->
      <div id="btResults" class="article" style="display:none">
        <h3>KPIs</h3>
        <ul class="metrics" id="btMetrics"></ul>

        <div id="btPlotWrap" style="margin-top:10px; display:none">
          <h3>Plot</h3>
          <div id="btPlots" class="grid" style="gap:12px"></div>
        </div>

        <div id="btKpiWrap" style="margin-top:10px; display:none">
          <h3>KPI Images</h3>
          <div id="btKpiImgs" class="grid" style="gap:12px"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="container footer">
    <small>© <span id="y"></span> [Aguirre Cabrol]</small>
  </footer>

  <script>
    // --------- Config & DOM refs ---------
    window.API_BASE = "https://fintech-portfolio-546985714630.europe-west1.run.app";
    document.getElementById('y').textContent = new Date().getFullYear();

    const sel        = document.getElementById('btStrategy');
    const statusEl   = document.getElementById('btStatus');
    const resultsWrap= document.getElementById('btResults');
    const metricsEl  = document.getElementById('btMetrics');
    const plotWrap   = document.getElementById('btPlotWrap');
    const plotsEl    = document.getElementById('btPlots');
    const kpiWrap    = document.getElementById('btKpiWrap');
    const kpiImgsEl  = document.getElementById('btKpiImgs');

    // --------- Helpers (declared before use) ---------
const ABS = (u) => {
  const abs = /^https?:\/\//i.test(u) ? u : (window.API_BASE.replace(/\/$/, '') + u);
  // hard-bust caches for PNGs (KPI gauges & pretty plot reuse filenames)
  return /\.png(?:$|\?)/i.test(abs)
    ? abs + (abs.includes('?') ? '&' : '?') + 't=' + Date.now()
    : abs;
};

    const toNum = (x) => {
      if (x === null || x === undefined || x === '') return undefined;
      const n = Number(String(x).replace(',', '.'));
      return Number.isFinite(n) ? n : undefined;
    };

    function formatValue(key, val) {
      if (typeof val === 'string') return val || '—';
      if (val === null || val === undefined || !isFinite(Number(val))) return '—';
      const pctKeys = ['TotalReturn_%', 'rnorm100_%', 'MaxDrawdown_%', 'WinRate_%'];
      if (pctKeys.includes(key)) {
        return (Number(val) * 100).toLocaleString(undefined, { maximumFractionDigits: 2 }) + ' %';
        }
      const digits = Math.abs(Number(val)) >= 100 ? 2 : 4;
      return Number(val).toLocaleString(undefined, { maximumFractionDigits: digits });
    }

    function renderResults(out) {
      // reset
      resultsWrap.style.display = 'none';
      plotWrap.style.display = 'none';
      kpiWrap.style.display = 'none';
      metricsEl.innerHTML = '';
      plotsEl.innerHTML   = '';
      kpiImgsEl.innerHTML = '';

      // ----- KPIs (numbers) -----
      const m = out?.metrics || {};
      const order = [
        'Symbol','Strategy','TotalReturn_%','rnorm100_%','SharpeDaily','SharpeAnnual',
        'Calmar','MaxDrawdown_%','TimeDD_bars','VWR','SQN','WinRate_%',
        'ProfitFactor','AvgTradePL','trades_total','Sortino'
      ];
      const rows = [];
      order.forEach(k => (k in m) && rows.push([k, m[k]]));
      Object.keys(m).forEach(k => { if (!order.includes(k)) rows.push([k, m[k]]); });
      metricsEl.innerHTML = rows.map(([k,v]) =>
        `<li><strong>${k.replaceAll('_',' ')}:</strong> ${formatValue(k,v)}</li>`
      ).join('');

      // ----- Big pretty plot (if provided) -----max-width:1200px;
      if (out?.plot) {
        const src = ABS(out.plot);
        plotsEl.innerHTML = `
          <img id="btPretty" src="${src}" alt="backtest plot"
               style="width:80%;border:1px solid #e5e7eb;border-radius:12px"
               onload="this.scrollIntoView({behavior:'smooth'})"
               onerror="this.closest('#btPlotWrap').style.display='none';">
        `;
        plotWrap.style.display = '';
      }

      // ----- KPI images grid (12 PNGs in fixed order; only those returned) -----
      const KPI_ORDER = [
        "Calmar.png","MaxDrawdown_%.png","ProfitFactor.png","rnorm100_%.png",
        "SharpeAnnual.png","SharpeDaily.png","Sortino.png","SQN.png",
        "TimeDD_bars.png","TotalReturn_%.png","VWR.png","WinRate_%.png"
      ];
      const urls = Array.isArray(out?.charts) ? out.charts.map(ABS) : [];
      const ordered = KPI_ORDER
        .map(name => urls.find(u => u.endsWith('/' + name) || u.includes('/' + name)))
        .filter(Boolean);

      if (ordered.length) {
        const caption = (u) => {
          const fn = u.split('/').pop().split('?')[0];
          return fn.replace('.png','').replaceAll('_',' ').replace('%','%');
        };
        kpiImgsEl.innerHTML = ordered.map(u => `
          <figure style="margin:0">
            <img src="${u}" alt="${caption(u)}"
                 style="max-width:100%;border:1px solid #e5e7eb;border-radius:12px" />
            <figcaption class="muted" style="text-align:center;margin-top:4px">${caption(u)}</figcaption>
          </figure>
        `).join('');
        kpiWrap.style.display = '';
      }

      resultsWrap.style.display = '';
      statusEl.textContent = '';
    }

    // --------- Strategy dropdown ---------
    (async () => {
      try {
        const res = await fetch(`${window.API_BASE}/api/strategies`);
        const data = res.ok ? await res.json() : { items: ["SmaCross", "Rsi2", "EmaCross"] };
        const items = data.items || data;
        sel.innerHTML = items.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch {
        sel.innerHTML = `<option value="SmaCross">SmaCross</option>`;
      }
    })();

    // --------- Submit handler ---------
    document.getElementById('btForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Running…';
      resultsWrap.style.display = 'none';
      plotWrap.style.display = 'none';
      kpiWrap.style.display = 'none';
      plotsEl.innerHTML = '';
      kpiImgsEl.innerHTML = '';

      const fd = new FormData(e.currentTarget);
      const payload = {
        symbol: (fd.get('symbol') || '').trim() || undefined,
        strategy: fd.get('strategy') || fd.get('strat') || undefined,
        start_period: fd.get('start_period') || undefined,
        end_period: fd.get('end_period') || undefined,
        starting_capital: toNum(fd.get('starting_capital')),
        commission: toNum(fd.get('commission')),
        slippage: toNum(fd.get('slippage')),
      };
      Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

      try {
        const res = await fetch(`${window.API_BASE}/api/backtest`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const msg = await res.text().catch(()=>'');
          throw new Error(`backtest failed: ${msg || res.status}`);
        }
        const out = await res.json();
        renderResults(out);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error running backtest. Please check inputs and try again.';
      }
    });
  </script>
</body>
</html>
