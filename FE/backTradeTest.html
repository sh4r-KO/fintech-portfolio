<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backtest Runner</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container about">
    <h2>Backtrader — Strategy Runner</h2>

    <form id="btForm" class="row two-col">
      <label>Symbol
        <input name="symbol" placeholder="AAPL" required />
      </label>
      <label>Strategy
        <select name="strategy" id="strategy" required></select>
      </label>
      <button type="submit" style="grid-column:1/-1">Run Backtest</button>
      <small id="status" class="muted" style="grid-column:1/-1"></small>
    </form>

    <div id="out" class="article" style="display:none">
      <h3>KPIs</h3>
      <ul id="metrics" class="metrics"></ul>
      <div id="plots" class="grid" style="gap:12px"></div>
    </div>
  </main>

  <script>
    const API = "https://fintech-portfolio-546985714630.europe-west1.run.app";

    // 1) Load strategies
    (async () => {
      const sel = document.getElementById('strategy');
      try {
        const r = await fetch(`${API}/api/strategies`);
        const data = await r.json(); // backend returns { items: [...] }
        const items = data.items || data;
        sel.innerHTML = items.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch {
        sel.innerHTML = `<option value="SmaCross">SmaCross</option>`;
      }
    })();

    // 2) Submit backtest — payload: { symbol, strategy } per OpenAPI
    document.getElementById('btForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const status = document.getElementById('status');
      const out = document.getElementById('out');
      const metrics = document.getElementById('metrics');
      const plots = document.getElementById('plots');
      status.textContent = "Running…";
      out.style.display = "none";
      metrics.innerHTML = ""; plots.innerHTML = "";

      const fd = new FormData(e.currentTarget);
      const payload = {
        symbol: fd.get('symbol').trim(),
        strategy: fd.get('strategy')
      };

      try {
        const res = await fetch(`${API}/api/backtest`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();

        // KPIs
        const m = json.metrics || {};
        const fmt = v => (v==null || Number.isNaN(v)) ? "—"
                         : Number(v).toLocaleString(undefined, { maximumFractionDigits: 4 });
        metrics.innerHTML = Object.entries(m)
          .map(([k,v]) => `<li><strong>${k.replaceAll('_',' ')}:</strong> ${fmt(v)}</li>`).join('');

        // Plots
        (json.plots || []).forEach(src => {
          const img = document.createElement('img');
          img.src = src;
          img.alt = "Backtest plot";
          img.style = "max-width:100%;border:1px solid #e5e7eb;border-radius:12px";
          plots.appendChild(img);
        });

        out.style.display = "";
        status.textContent = "";
      } catch (err) {
        console.error(err);
        status.textContent = "Backtest failed. Check symbol/strategy and server logs.";
      }
    });
  </script>
</body>
</html>
