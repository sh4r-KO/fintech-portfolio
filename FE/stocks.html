<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stocks — Fintech & PySpark Portfolio</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="container header">
    <a href="/" class="logo">← Home</a>
    <nav>
      <a href="/#projects">Projects</a>
      <a href="compound.html">Calculator</a>
      <a href="forex.html">FX</a>
      <a href="stocks.html">Stocks</a>
      <a href="/#about">About</a>
      <a href="/#contact">Contact</a>
    </nav>
  </header>

  <main class="container">
    <section class="about">
      <h2>Stock Plotter — Monthly Adjusted</h2>
      <form id="stkForm">
        <div class="row two-col">
          <label>Ticker
            <input name="symbol" id="stkSymbol" placeholder="AAPL" value="AAPL" required>
          </label>
          <label>Range
            <select name="period" id="stkPeriod" required>
              <option value="1mo">1mo</option>
              <option value="3mo">3mo</option>
              <option value="6mo">6mo</option>
              <option value="1y" selected>1y</option>
              <option value="5y">5y</option>
              <option value="10y">10y</option>
              <option value="ytd">ytd</option>
              <option value="max">max</option>
            </select>
          </label>
        </div>
        <button type="submit">Fetch & Plot</button>
        <small id="stkStatus" class="muted"></small>
      </form>

      <div id="stkResults" class="article" style="display:none">
        <h3>Result</h3>
        <ul class="metrics" id="stkSummary"></ul>
        <div id="stkChartWrap" style="margin-top:10px; display:none">
          <h3>Chart</h3>
          <img id="stkChart" style="max-width:100%;border:1px solid #e5e7eb;border-radius:12px" alt="Stock chart"/>
        </div>
      </div>
    </section>
  </main>

  <footer class="container footer"><small>© <span id="y"></span> [Your Name]</small></footer>

  <script>window.API_BASE="https://fintech-portfolio-546985714630.europe-west1.run.app";</script>
  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    const form = document.getElementById('stkForm');
    const statusEl = document.getElementById('stkStatus');
    const resultsWrap = document.getElementById('stkResults');
    const summaryEl = document.getElementById('stkSummary');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Loading…';
      resultsWrap.style.display = 'none';

      const data = {
        symbol: document.getElementById('stkSymbol').value.trim().toUpperCase() || 'AAPL',
        period: document.getElementById('stkPeriod').value
      };

      try {
        // JSON meta
        const res = await fetch(`${window.API_BASE}/api/stocks/series`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error('series failed');
        const out = await res.json();

        const fmt = (x, d=2) => Number(x).toLocaleString(undefined, {maximumFractionDigits:d});
        const color = out.change_abs >= 0 ? '#34d399' : '#ef4444';
        summaryEl.innerHTML = `
          <li><strong>${out.symbol}</strong></li>
          <li><strong>Rows:</strong> ${out.rows.toLocaleString()}</li>
          <li><strong>First:</strong> ${out.first_date} — <strong>Last:</strong> ${out.last_date}</li>
          <li><strong>Close:</strong> ${fmt(out.close_first)} → ${fmt(out.close_last)}</li>
          <li><strong>Change:</strong> <span style="color:${color}">${fmt(out.change_abs)} (${fmt(out.change_pct)}%)</span></li>
        `;
        resultsWrap.style.display = '';

        // PNG chart
        const chartWrap = document.getElementById('stkChartWrap');
        const chartImg  = document.getElementById('stkChart');
        const resImg = await fetch(`${window.API_BASE}/api/stocks/plot`, {
          method: 'POST', headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });
        if (resImg.ok) {
          const blob = await resImg.blob();
          const prev = chartImg.dataset.url;
          if (prev) URL.revokeObjectURL(prev);
          const url = URL.createObjectURL(blob);
          chartImg.src = url; chartImg.dataset.url = url;
          chartWrap.style.display = '';
        } else {
          chartWrap.style.display = 'none';
        }
        statusEl.textContent = '';
      } catch (err) {
        statusEl.textContent = 'Error. Please check the ticker or try again later.';
      }
    });
  </script>
</body>
</html>
